---
title: 编译和链接
---
[[toc]]

## 编译系统
![](https://s2.ax1x.com/2019/10/31/KTYwAU.jpg)

### 预处理（产生.i文件）
```cpp
g++ -E helloworld.cpp -o helloworld.i
```
1. 将`#define`删除，并将宏定义展开
2. 处理一些条件预编译指令，如`#ifndef`,`#ifdef`,`#elif`,`#else`,`#endif`（作用：防止重复包含头文件）等。将不必要的代码过滤掉。
3. 处理`#include`预编译指令，将被包含的文件插入到该预编译指令的位置。这个过程是递归进行的，因为被包含的文件也包含其他文件
4. 过滤掉所有注释里面的内容
5. 添加行号和文件名标识
6. 保留`#program`编译器指令，因为编译器需要使用他们

### 编译（产生.s文件）
```cpp
g++ -S helloworld.i -o helloworld.s
```
编译就是将预处理的文件进行一系列的词法分析、语法分析、语义分析，以及优化后产生相应的汇编代码文件。

### 汇编（产生.o或.obj文件）
汇编过程实际上是把汇编语言代码翻译成目标机器指令的过程，即生成目标文件。目标文件中所存放的也就是与源程序等效的目标机器语言代码。目标文件由段组成，通常一个目标文件至少有两个段：
- 代码段：该段中所包含的主要是程序的指令，该段一般是可读和可执行的，但一般不可写。
- 数据段：主要存放程序中要用到的各种全局变量或静态的数据。一般数据段都是可读、可写、可执行的。

### 链接（产生.out或.exe文件）
链接就是把每个源代码独立的编译，然后按照它们的要求将它们组装起来，链接主要解决的是源代码之间的相互依赖问题，链接的过程包括地址和空间的分配，符号决议，和重定位等这些步骤。

## 静态链接
![](https://s2.ax1x.com/2019/10/31/KTY0NF.jpg)

静态链接器以一组可重定位目标文件为输入，生成一个完全链接的可执行目标文件作为输出。链接器主要完成以下两个任务：

- 符号解析：每个符号对应于一个函数、一个全局变量或一个静态变量，符号解析的目的是将每个符号引用与一个符号定义关联起来。
- 重定位：链接器通过把每个符号定义与一个内存位置关联起来，然后修改所有对这些符号的引用，使得它们指向这个内存位置。

## 目标文件
可执行目标文件：可以直接在内存中执行；

可重定位目标文件：可与其它可重定位目标文件在链接阶段合并，创建一个可执行目标文件；

共享目标文件：这是一种特殊的可重定位目标文件，可以在运行时被动态加载进内存并链接；

## 动态链接
静态库有以下两个问题：
- 当静态库更新时那么整个程序都要重新进行链接；
- 对于 `printf` 这种标准函数库，如果每个程序都要有代码，这会极大浪费资源。

共享库是为了解决静态库的这两个问题而设计的，在 `Linux` 系统中通常用 `.so` 后缀来表示，`Windows` 系统上它们被称为 `DLL`。它具有以下特点：
- 在给定的文件系统中一个库只有一个文件，所有引用该库的可执行目标文件都共享这个文件，它不会被复制到引用它的可执行文件中；
- 在内存中，一个共享库的 .text 节（已编译程序的机器代码）的一个副本可以被不同的正在运行的进程共享。

![](https://s2.ax1x.com/2019/10/31/KTYnnP.jpg)